
> [redo log 和 binlog 日志分别是什么](https://github.com/ProgrammerGoGo/document/blob/main/MySQL/redo%20log%20%E5%92%8C%20binlog%20%E6%97%A5%E5%BF%97%E5%88%86%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88.md)

# 什么是脏页
mysql脏页和干净页：  
当内存数据页和磁盘数据页上的内容不一致时，我们称这个内存页为 脏页；  
内存数据写入磁盘后（术语就是flush），内存页上的数据和磁盘页上的数据就一致了，我们称这个内存页为干净页。  
不管是 脏页 还是 干净页 ，他们都在内存中。  

内存里的数据写入磁盘的过程，术语就是flush。  
刷脏页可能导致MySQL的抖动。

# 什么情况会引发数据库的flush过程呢？

## 场景一
InnoDB的`redo log`写满了。这时候系统会停止所有更新操作，把`checkpoint`往前推进，`redo log`留出空间可以继续写。

> 对性能的影响：这种情况是InnoDB要尽量避免的。因为出现这种情况的时候，整个系统就不能再接受更新了，所有的更新都必须堵住。如果你从监控上看，这时候更新数会跌为0。

![image](https://github.com/ProgrammerGoGo/document/assets/98639494/80b0206d-c59b-4242-81ff-657f0d03feec)

## 场景二
系统内存不足。当需要新的内存页，而内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的是“脏页”，就要先将脏页写到磁盘。

> 对性能的影响：这种情况其实是常态。InnoDB用缓冲池（buffer pool）管理内存，缓冲池中的内存页有三种状态：  
> * 第一种是，还没有使用的；  
> * 第二种是，使用了并且是干净页；
> * 第三种是，使用了并且是脏页。  
> InnoDB的策略是尽量使用内存，因此对于一个长时间运行的库来说，未被使用的情况很少。
>
> 而当要读入的数据页没有在内存的时候，就必须到缓冲池中申请一个数据页。这时候只能把最久不使用的数据页从内存中淘汰掉：如果要淘汰的是一个干净页，就直接释放出来复用；但如果是脏页呢，就必须将脏页先刷到磁盘，变成干净页后才能复用。

## 场景三
MySQL认为系统“空闲”的时候。只要有机会就刷一点“脏页”。
> 对性能的影响：属于MySQL空闲时的操作，这时系统没什么压力。

## 场景四
MySQL正常关闭的情况。这时候，MySQL会把内存的脏页都`flush`到磁盘上，这样下次MySQL启动的时候，就可以直接从磁盘上读数据，启动速度会很快。

> 对性能的影响：数据库本来就要关闭了，无所谓性能。


所以，刷脏页虽然是常态，但是出现以下这两种情况，都是会明显影响性能的：
1. 一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长；

2. 日志写满，更新全部堵住，写性能跌为0，这种情况对敏感业务来说，是不能接受的。

所以，InnoDB需要有控制脏页比例的机制，来尽量避免上面的这两种情况。

# InnoDB刷脏页的控制策略

[InnoDB刷脏页的控制策略](https://funnylog.gitee.io/mysql45/12%E8%AE%B2%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E7%9A%84MySQL%E4%BC%9A%E2%80%9C%E6%8A%96%E2%80%9D%E4%B8%80%E4%B8%8B.html)








